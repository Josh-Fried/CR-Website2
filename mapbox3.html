<html>
  <head>
    <meta charset="utf-8" />
    <title>Click to Enlarge Map</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 20px; /* Add some padding to see the elements */
        font-family: sans-serif;
        background-color: #f0f0f0;
      }

      /* This is the container where your image used to be. */
      .feature-image-container {
        width: 100%;
        max-width: 800px; /* Example max-width */
        margin: 20px auto; /* Center the container */
        border: 1px solid #ccc;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      /* Style for the map container */
      #map {
        /* The map will now fill its container. */
        width: 100%;
        height: 450px; /* Set a height for the initial view */
        cursor: pointer;

        /* Smooth transition for when it becomes fullscreen */
        transition: all 0.5s ease;

        z-index: 1; /* Keep it in the normal document flow */
      }

      /* Style for the enlarged, centered state */
      #map.fullscreen {
        position: fixed; /* Lifts the map out of the page flow */
        top: 50%;
        left: 50%;
        /* Use transform to perfectly center it */
        transform: translate(-50%, -50%);
        width: 90vw; /* 90% of the viewport width */
        height: 90vh; /* 90% of the viewport height */
        border: 3px solid white;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        z-index: 2000; /* Ensure it's on top of everything */
        cursor: default; /* Change cursor back to normal for the enlarged map */
      }

      /* New style for the background overlay */
      #map-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black */
        z-index: 1999; /* Just below the fullscreen map */
        cursor: pointer;

        /* Hide by default and set up for smooth transition */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease, visibility 0.5s ease;
      }

      /* New class to make the overlay visible */
      #map-overlay.visible {
        opacity: 1;
        visibility: visible;
      }
    </style>
  </head>
  <body>
    <!-- New overlay div -->
    <div id="map-overlay"></div>

    <h2>A Section of Your Page</h2>
    <p>
      Here is some content on your website, and below is the map where your
      image used to be. Click it to see the enlarged view.
    </p>

    <!-- The map is now placed inside the feature-image-container -->
    <div class="feature-image-container">
      <div id="map"></div>
    </div>

    <p>Here is some more content below the map container.</p>

    <script>
      mapboxgl.accessToken =
        "pk.eyJ1Ijoiam9zaGZyaWVkIiwiYSI6ImNtZzVweXhqbTA4ZXAya3B4M2QzcXF4OWEifQ.GPxLToDEuWvH8-VHGtPh6Q";

      const locations = [
        // 1. Start in the Atlantic
        { center: [-40, 30], zoom: 1.0, duration: 8000, pause: 8000 },

        // 2. Intermediate waypoint over Asia to force eastward travel. No pause here.
        // { center: [90, 30], zoom: 1.0, duration: 8000, pause: 0 },

        // 2. Intermediate waypoint over Asia to force eastward travel. No pause here.
        // { center: [120, 30], zoom: 1.0, duration: 8000, pause: 0 },

        // 3. Arrive at the Pacific destination (using positive longitude to continue east).
        { center: [277.385, 2.965], zoom: 1, duration: 5000, pause: 2000 },

        // 4. Zoom into Costa Rica.
        { center: [-84.2, 9.75], zoom: 6.5, duration: 5000, pause: 2000 },

        // 5. Zoom into the specific resort.
        {
          center: [-85.623, 10.608],
          zoom: 11.01,
          duration: 5000,
          pause: 2000,
        },
      ];
      let currentLocationIndex = 0;

      const map = new mapboxgl.Map({
        container: "map", // container ID
        style: "mapbox://styles/joshfried/cmg6vnoj700gy01rh9dcnfkw5",
        center: locations[0].center, // Start at the first, wide globe view
        zoom: locations[0].zoom,
      });

      // Get references to the map container and the new overlay
      const mapContainer = document.getElementById("map");
      const overlay = document.getElementById("map-overlay");

      // Function to open the map modal
      function openMap() {
        mapContainer.classList.add("fullscreen");
        overlay.classList.add("visible");
        setTimeout(() => {
          map.resize();
        }, 250);
      }

      // Function to close the map modal
      function closeMap() {
        mapContainer.classList.remove("fullscreen");
        overlay.classList.remove("visible");
        setTimeout(() => {
          map.resize();
        }, 250);
      }

      // An async function to handle the animation loop precisely
      async function runAnimationLoop() {
        // Wait for the map to fully load before starting the animation
        await new Promise((resolve) => map.on("load", resolve));

        while (true) {
          // If the map is enlarged, pause the animation loop
          if (mapContainer.classList.contains("fullscreen")) {
            // Wait for a moment before checking again
            await new Promise((resolve) => setTimeout(resolve, 500));
            continue; // Skip the rest of this loop iteration
          }

          const nextLocation = locations[currentLocationIndex];

          // Set the duration for the upcoming flight.
          const flightOptions = {
            ...nextLocation,
          };

          // Start flying to the next location
          map.flyTo(flightOptions);

          // Wait for the duration of the flight plus the specified pause
          await new Promise((resolve) =>
            setTimeout(resolve, flightOptions.duration + nextLocation.pause)
          );

          // Move to the next location index for the next loop
          currentLocationIndex = (currentLocationIndex + 1) % locations.length;
        }
      }

      // Start the animation loop
      runAnimationLoop();

      // Add a click event listener to the map container
      mapContainer.addEventListener("click", () => {
        if (!mapContainer.classList.contains("fullscreen")) {
          openMap();
        }
      });

      // Add a click event listener to the overlay
      overlay.addEventListener("click", () => {
        if (mapContainer.classList.contains("fullscreen")) {
          closeMap();
        }
      });
    </script>
  </body>
</html>
